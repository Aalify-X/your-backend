<!DOCTYPE html>
<html>
<head>
    <title>Progrify Verification</title>
    <script src="https://cdn.whop.com/js/embed.js"></script>
</head>
<body>
    <div id="whop-verification-container"></div>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Only initialize widget if not in trial period
        if (!isTrialActive()) {
            window.whopWidget.initialize({
                sellerId: "app_dyAJyqA7FjKF24",
                productId: "prod_2bPcTPEWlcclz",
                containerId: "whop-verification-container",
                apikey:"dMG9tvJDh7Zbk-icI5B6vfiR-xIY3Ij5lhU7JSwv8sM" ,
                onSuccess: function(data) {
                    verifyWithBackend(data.token);
                },
                onFailure: function(error) {
                    alert("Verification failed: " + error.message);
                }
            });
        }
        
        function isTrialActive() {
            // Check with backend if trial is active
            return fetch('/api/verify', { method: 'POST' })
                .then(res => res.json())
                .then(data => data.status === 'trial_active');
        }
        
        function verifyWithBackend(token) {
            fetch('/api/verify', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'verified') {
                    window.location.href = "/"; // Redirect to app
                } else {
                    alert("Verification failed");
                }
            });
        }
    });
    </script>
</body>
</html>
